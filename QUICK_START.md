# 🚀 T-Engine V2 快速使用指南

## ✅ 已完成的工作

1. ✅ **合约代码**: `contracts/TEngineV2.sol`
2. ✅ **编译配置**: `hardhat.config.js`
3. ✅ **升级脚本**: `scripts/upgradeTEngineV2.js`
4. ✅ **测试脚本**: `scripts/compileTest.js`
5. ✅ **前端更新**: `admin.html` 和 `t-engine.html`
6. ✅ **编译测试**: 已通过 ✓

---

## 🎯 立即开始

### 步骤1: 编译测试 (已完成 ✓)

```bash
cd C:\Users\CDD\Desktop\newdp
npm run test-compile
```

**结果**: ✅ 编译测试通过!

---

### 步骤2: 升级到主网 (由您执行)

⚠️ **重要**: 这将使用您的Owner私钥升级主网合约

```bash
npm run upgrade
```

**预期结果**:
```
============================================================
🚀 T-Engine V2 升级脚本
============================================================
📝 部署账户: 0x你的地址
💰 账户余额: X.XX BERA

⏳ 正在升级 TEngine 到 V2...
✅ TEngine 已成功升级到 V2!
📍 代理地址 (不变): 0xd9661D56659B80A875E42A51955434A0818581D8
📍 新实现合约地址: 0x新地址

🎉 升级完成!
============================================================
```

**所需Gas**: 约 0.5-1 BERA

---

### 步骤3: 验证升级 (在前端)

#### A. 打开 admin.html

1. 连接钱包 (Owner账户)
2. 滚动到 **T-Engine** 卡片
3. 检查新功能:
   - ✅ "释放周期时长" 输入框和按钮
   - ✅ "🚀 提前释放一天量" 按钮
   - ✅ "释放周期时长" 显示: 86400秒 (24.0小时)
   - ✅ "当前Epoch" 显示正常

#### B. 打开 t-engine.html

1. 连接钱包
2. 滚动到质押区域下方
3. 检查新卡片:
   - ✅ "🎁 我的邀请收益" 卡片
   - ✅ Pass等级显示
   - ✅ 邀请奖励率显示
   - ✅ 可用份额显示

---

## 🧪 测试功能 (可选)

### 测试1: 设置1小时释放周期

**在 admin.html**:
1. 输入框填入: `3600`
2. 点击 "设置周期"
3. 确认交易
4. 验证 "释放周期时长" 显示: 3600秒 (1.0小时)

### 测试2: 强制提前释放

**在 admin.html**:
1. 点击 "🚀 提前释放一天量"
2. 确认警告提示
3. 确认交易
4. 所有用户现在可以领取奖励

### 测试3: 恢复24小时周期

**测试完成后,必须恢复**:
1. 输入框填入: `86400`
2. 点击 "设置周期"
3. 确认交易

---

## 📊 升级前后对比

| 功能 | 升级前 | 升级后 |
|------|--------|--------|
| 邀请奖励来源 | 矿池支出 | ✨ 邀请人份额提前释放 |
| 邀请奖励到账 | 立即到账 | ✨ 需claim领取 |
| 邀请奖励税费 | 不扣税 | ✨ 扣10%税费 |
| 邀请奖励率 | 5%/5%/8%/12% | ✨ 3%/8%/11%/15% |
| 释放周期 | 固定24小时 | ✨ 可配置 (1-24小时) |
| 测试能力 | 需等待 | ✨ 可强制释放 |
| 前端显示 | 基础信息 | ✨ 邀请收益卡片 |
| Admin控制 | 基础控制 | ✨ 高级测试功能 |

---

## ⚠️ 重要提醒

### 1. 邀请奖励机制说明

**给用户的说明**:
> 当您邀请新用户质押时,您将从自己的**未释放份额**中提前释放奖励。  
> 邀请奖励**不立即到账**,需要调用claim()领取,并**扣除10%税费**。  
> 这意味着您的未来释放速度会相应降低。

**示例**:
- 您有 4000 DP 未释放份额
- 邀请1人质押 1000 DP (假艘15%奖励率 - Exclusive Pass)
- 您的pendingRewards增加: 150 DP
- 调用claim()后实际到账: 135 DP (扣10%税费)
- 剩余份额: 3850 DP (后续释放基数降低)

### 2. 测试功能使用规则

⚠️ **setEpochDuration**:
- 仅在测试期使用
- 正式运行**必须保持** 86400秒
- 影响所有用户

⚠️ **forceReleaseOneEpoch**:
- 仅用于测试或紧急情况
- 会让所有用户提前获得奖励
- 谨慎使用

---

## 📞 故障排除

### 问题1: 编译失败

**解决方案**:
```bash
# 清理缓存
rm -rf artifacts cache

# 重新编译
npm run compile
```

### 问题2: 升级失败 - Gas不足

**解决方案**:
- 确保账户至少有 1 BERA
- 增加 gasPrice (在 hardhat.config.js)

### 问题3: 前端不显示新功能

**解决方案**:
- 刷新页面 (Ctrl+F5)
- 清除浏览器缓存
- 重新连接钱包

---

## 🎉 升级完成检查清单

### 合约层面:
- [ ] 执行 `npm run upgrade` 成功
- [ ] 获得新实现合约地址
- [ ] epochDuration = 86400
- [ ] 旧数据正常显示

### 前端层面:
- [ ] admin.html 显示新控制项
- [ ] t-engine.html 显示邀请收益卡片
- [ ] 数据正常刷新
- [ ] 事件监听正常

### 功能测试:
- [ ] 邀请奖励正常发放
- [ ] Pass等级正确识别
- [ ] epochDuration可调整
- [ ] 强制释放可触发
- [ ] 原有功能正常

---

## 📞 需要帮助?

查看完整文档: `UPGRADE_GUIDE.md`

---

## 🎊 准备就绪!

现在您可以执行升级命令:

```bash
npm run upgrade
```

**祝升级顺利!** 🚀
