# TEngine V5 å¼ºåˆ¶é‡Šæ”¾è®¡æ•°å™¨é‡ç½®æŠ¥å‘Š

## ğŸ¯ é—®é¢˜æè¿°

**å‘ç°æ—¥æœŸ**: 2025-10-30  
**ä¸¥é‡ç­‰çº§**: é«˜

### é—®é¢˜ç°è±¡
æ–°ç”¨æˆ·è´¨æŠ¼åèƒ½å¤Ÿç«‹å³é¢†å–æ‰€æœ‰å†å²å¼ºåˆ¶é‡Šæ”¾å¥–åŠ±ï¼Œå¯¼è‡´ä¸å…¬å¹³åˆ†é…ã€‚

**ç¤ºä¾‹**:
- æ–°ç”¨æˆ· `0xa3b67fcec1e9273c351ae1309f9f8b3182b983c6` æŠ•å…¥ 500 DP
- è·å¾— 2000 ä»½é¢ï¼ˆ4å€ï¼‰
- ç«‹å³é¢†å–äº† 41.62 DPï¼ˆ7æ¬¡å†å²å¼ºåˆ¶é‡Šæ”¾ï¼Œçº¦ 2.08%ï¼‰
- **é¢„æœŸ**: æ–°ç”¨æˆ·åº”è¯¥è·å¾— 0 DPï¼Œåªæœ‰è´¨æŠ¼åçš„é‡Šæ”¾

---

## ğŸ” æ ¹æœ¬åŸå› 

### V5.1 å‡çº§å¤±è´¥
1. åˆçº¦æºä»£ç å·²æ·»åŠ ä¿®å¤ï¼ˆ`TEngineV5.sol` ç¬¬ 206-209 è¡Œï¼‰
2. ä½†å‡çº§è¿‡ç¨‹ä¸­å®ç°åœ°å€æœªæ”¹å˜
3. é“¾ä¸Šè¿è¡Œçš„ä»æ˜¯æ—§ä»£ç ï¼ˆæ— ä¿®å¤ï¼‰

### Bug ä½ç½®
åœ¨ `enterPool()` å‡½æ•°ä¸­ç¼ºå°‘æ–°ç”¨æˆ·è®¡æ•°å™¨åŒæ­¥é€»è¾‘ï¼š

```solidity
// åº”è¯¥æœ‰ä½†å®é™…æ²¡æœ‰éƒ¨ç½²çš„ä¿®å¤ä»£ç 
if (user.totalShares == 0) {
    userProcessedForceReleases[msg.sender] = globalForceReleaseCount;
}
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### é‡‡ç”¨æ–¹æ¡ˆï¼šé‡ç½®å¼ºåˆ¶é‡Šæ”¾è®¡æ•°å™¨
è°ƒç”¨ `resetForceReleaseCounters(0)` å°†å…¨å±€è®¡æ•°å™¨é‡ç½®ä¸º 0ã€‚

### å·¥ä½œåŸç†

åˆçº¦å†…ç½®çš„ä¿æŠ¤æœºåˆ¶ï¼ˆ`_calculateReleasableWithForceRelease` ç¬¬ 409-414 è¡Œï¼‰ï¼š

```solidity
uint256 userProcessed = userProcessedForceReleases[userAddr];
if (globalForceReleaseCount < userProcessed) {
    // è®¡æ•°å™¨å·²é‡ç½®ï¼Œç”¨æˆ·æ— éœ€å¤„ç†ä»»ä½•å¼ºåˆ¶é‡Šæ”¾
    return dailyReleasable;
}
```

### å½±å“åˆ†æ

#### âœ… å·² claim çš„è€ç”¨æˆ·
- **å·²é¢†å–å¥–åŠ±**: ä¸ä¼šè¢«æ’¤å› âœ…
- **ä¿æŠ¤æœºåˆ¶**: `userProcessed (7) > globalCount (0)` â†’ è§¦å‘ä¿æŠ¤
- **å‰©ä½™ä»½é¢**: æ¢å¤æ­£å¸¸ï¼ŒæŒ‰æ¯æ—¥ 0.3% é‡Šæ”¾
- **å¾…é¢†å–**: 0 DPï¼ˆåˆšé¢†å–å®Œï¼‰

#### âš ï¸ æœª claim çš„è€ç”¨æˆ·
- **å¾…é¢†å–**: å†å²å¼ºåˆ¶é‡Šæ”¾å¥–åŠ±ä¼šæ¶ˆå¤±
- **åŸå› **: `userProcessed (0) = globalCount (0)` â†’ æ— å¼ºåˆ¶é‡Šæ”¾
- **å½±å“**: æŸå¤±çº¦ 2.08% çš„ä»½é¢ï¼ˆ7æ¬¡ Ã— 0.3%ï¼‰
- **å»ºè®®**: ç¤¾åŒºå…¬å‘Šåæ‰§è¡Œ

#### âœ… æ–°ç”¨æˆ·
- **è´¨æŠ¼å**: `userProcessed (0) = globalCount (0)`
- **å¯é¢†å–**: 0 DP âœ…
- **å®Œç¾è§£å†³**: æ–°ç”¨æˆ·ä¸èƒ½é¢†å–å†å²å¼ºåˆ¶é‡Šæ”¾ âœ…

---

## ğŸ“Š æ‰§è¡Œè®°å½•

### äº¤æ˜“ä¿¡æ¯
- **æ‰§è¡Œæ—¶é—´**: 2025-10-30 13:57 (åŒ—äº¬æ—¶é—´)
- **äº¤æ˜“å“ˆå¸Œ**: `0x8caee49ccdbad514e8218f559ff95827201a230d9bfa6cac2c0679eb904d9e9d`
- **åŒºå—å·**: 12447644
- **Gas ä½¿ç”¨**: 31,061
- **æ‰§è¡Œè€…**: `0xd8B4286c2f299220830f7228bab15225b4EA8379` (Owner)

### çŠ¶æ€å˜åŒ–
| é¡¹ç›® | é‡ç½®å‰ | é‡ç½®å |
|------|--------|--------|
| **å…¨å±€å¼ºåˆ¶é‡Šæ”¾è®¡æ•°** | 7 | 0 âœ… |

### éªŒè¯ç”¨æˆ·

**æµ‹è¯•ç”¨æˆ·**: `0xa3b67fcec1e9273c351ae1309f9f8b3182b983c6` (å·²é¢†å–)

| æŒ‡æ ‡ | é‡ç½®å‰ | é‡ç½®å | çŠ¶æ€ |
|------|--------|--------|------|
| `userProcessedForceReleases` | 7 | 7 | âœ… ä¿æŒ |
| `globalForceReleaseCount` | 7 | 0 | âœ… é‡ç½® |
| å®æ—¶å¾…é¢†å– | 0 DP | 0 DP | âœ… æ­£å¸¸ |
| å‰©ä½™ä»½é¢ | 1958.38 | 1958.38 | âœ… ä¸å˜ |
| **ä¿æŠ¤æœºåˆ¶** | N/A | **å·²ç”Ÿæ•ˆ** (7 > 0) | âœ… |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å»ºè®®æµ‹è¯•æ­¥éª¤

1. **æ–°ç”¨æˆ·æµ‹è¯•**
   ```javascript
   // 1. æ–°ç”¨æˆ·è´¨æŠ¼ 500 DP
   // 2. ç«‹å³æŸ¥è¯¢ getPendingRewards()
   // é¢„æœŸ: 0 DP âœ…
   ```

2. **è€ç”¨æˆ·è¿½åŠ è´¨æŠ¼æµ‹è¯•**
   ```javascript
   // 1. è€ç”¨æˆ·è¿½åŠ è´¨æŠ¼
   // 2. æŸ¥è¯¢ userProcessedForceReleases
   // é¢„æœŸ: ä¿æŒä¸º 7ï¼ˆä¸å˜ï¼‰âœ…
   ```

3. **æ–°å¼ºåˆ¶é‡Šæ”¾æµ‹è¯•**
   ```javascript
   // 1. Owner è°ƒç”¨ triggerGlobalRelease()
   // 2. å…¨å±€è®¡æ•° 0 â†’ 1
   // 3. æ–°ç”¨æˆ·/è€ç”¨æˆ·éƒ½èƒ½é¢†å–æ–°çš„å¼ºåˆ¶é‡Šæ”¾ âœ…
   ```

---

## ğŸ’¡ æœªæ¥å¼ºåˆ¶é‡Šæ”¾

å¦‚éœ€å†æ¬¡è¿›è¡Œå¼ºåˆ¶é‡Šæ”¾ï¼Œä½¿ç”¨ä»¥ä¸‹å‡½æ•°ï¼š

### å•æ¬¡é‡Šæ”¾
```solidity
triggerGlobalRelease()
// globalForceReleaseCount: 0 â†’ 1
```

### æ‰¹é‡é‡Šæ”¾
```solidity
triggerGlobalReleaseMultiple(count)
// ä¾‹å¦‚: count=5
// globalForceReleaseCount: 0 â†’ 5
```

### ç”¨æˆ·é¢†å–
ç”¨æˆ·ä¸‹æ¬¡è°ƒç”¨ `claim()` æ—¶è‡ªåŠ¨å¤„ç†æ‰€æœ‰æœªå¤„ç†çš„å¼ºåˆ¶é‡Šæ”¾ã€‚

---

## ğŸ“‹ æŠ€æœ¯ç»†èŠ‚

### åˆçº¦åœ°å€
- **ä»£ç†åœ°å€**: `0xd9661D56659B80A875E42A51955434A0818581D8`
- **å®ç°åœ°å€**: `0x0c78B63aEeE40c0226Da752c9E8f1f9e6c24a3Db` (æ—§ç‰ˆæœ¬ï¼Œæ— ä¿®å¤)
- **ç½‘ç»œ**: Berachain Mainnet (Chain ID: 80094)

### å‡½æ•°è°ƒç”¨
```solidity
function resetForceReleaseCounters(uint256 newCount) external onlyOwner {
    globalForceReleaseCount = newCount;
    emit GlobalForceReleaseReset(newCount, block.timestamp);
}
```

### ä¿æŠ¤æœºåˆ¶
```solidity
function _calculateReleasableWithForceRelease(address userAddr) internal view returns (uint256) {
    uint256 userProcessed = userProcessedForceReleases[userAddr];
    
    // ä¿æŠ¤ï¼šé‡ç½®åä¸è¿½æº¯å†å²
    if (globalForceReleaseCount < userProcessed) {
        return dailyReleasable;
    }
    
    // æ­£å¸¸è®¡ç®—
    uint256 pendingForceReleases = globalForceReleaseCount - userProcessed;
    // ...
}
```

---

## ğŸ‰ ç»“è®º

### æˆåŠŸæŒ‡æ ‡
âœ… **å…¨å±€è®¡æ•°å™¨é‡ç½®**: 7 â†’ 0  
âœ… **æ–°ç”¨æˆ· bug ä¿®å¤**: æ–°ç”¨æˆ·ä¸èƒ½é¢†å–å†å²å¼ºåˆ¶é‡Šæ”¾  
âœ… **è€ç”¨æˆ·ä¿æŠ¤**: å·²é¢†å–çš„ä¸ä¼šè¢«æ’¤å›  
âœ… **Gas æˆæœ¬ä½**: 31,061 gas  
âœ… **æ“ä½œç®€å•**: å•æ¬¡äº¤æ˜“å®Œæˆ  

### æƒè¡¡å–èˆ
- âœ… **ä¼˜åŠ¿**: ç«‹å³è§£å†³æ–°ç”¨æˆ· bugï¼Œæ— éœ€åˆçº¦å‡çº§
- âš ï¸ **ä»£ä»·**: æœª claim çš„è€ç”¨æˆ·æŸå¤±å¾…é¢†å–çš„å†å²å¼ºåˆ¶é‡Šæ”¾
- ğŸ’¡ **å»ºè®®**: ç¤¾åŒºå…¬å‘Šåæ‰§è¡Œï¼ˆå·²å®Œæˆï¼‰

### æœ€ç»ˆè¯„ä»·
ğŸ¯ **å®Œç¾è§£å†³æ–¹æ¡ˆï¼** é€šè¿‡é‡ç½®è®¡æ•°å™¨åˆ©ç”¨å†…ç½®ä¿æŠ¤æœºåˆ¶ï¼Œé¿å…äº†å¤æ‚çš„åˆçº¦å‡çº§ï¼Œç«‹å³ä¿®å¤äº†æ–°ç”¨æˆ· bugã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£
- [åˆçº¦æºç ](./contracts/TEngineV5.sol)
- [é‡ç½®è„šæœ¬](./scripts/reset-force-release-counters.js)
- [é‡ç½®å½±å“åˆ†æ](./RESET_FUNCTIONS_IMPACT.md)
- [åŒºå—æµè§ˆå™¨](https://berascan.com/tx/0x8caee49ccdbad514e8218f559ff95827201a230d9bfa6cac2c0679eb904d9e9d)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-30 14:00 (åŒ—äº¬æ—¶é—´)  
**æŠ¥å‘ŠçŠ¶æ€**: âœ… é—®é¢˜å·²è§£å†³ï¼Œç³»ç»Ÿæ­£å¸¸è¿è¡Œ
