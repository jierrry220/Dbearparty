<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debear Party - Owner 控制台</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; background:#0f172a; color:#e2e8f0; margin:0; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .header { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:20px; margin-bottom:16px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn { background:#4f46e5; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.secondary { background:#10b981; }
    .btn.warning { background:#f59e0b; }
    .btn.danger { background:#ef4444; }
    .card { background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:16px; margin-top:16px; }
    .card h2 { margin:0 0 12px; font-size:18px; color:#93c5fd; }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .group { margin-bottom:12px; }
    .group label { display:block; font-size:13px; color:#9ca3af; margin-bottom:6px; }
    .group input, .group select { width:100%; padding:10px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; }
    .switch { display:flex; align-items:center; gap:8px; }
    .switch input { width:auto; }
    .muted { color:#9ca3af; font-size:12px; }
    .stat { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #1f2937; font-size:14px; }
    .stat:last-child { border-bottom:0; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#111827; border:1px solid #1f2937; font-size:12px; color:#9ca3af; }
    .msg { margin-top:10px; font-size:13px; }
    a { color:#93c5fd; text-decoration:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="row">
        <h1 style="margin:0; font-size:22px; color:#bfdbfe;">🛠️ Debear Party - Owner 控制台</h1>
        <span class="pill" id="ownerBadge">未连接</span>
        <div style="flex:1 1 auto"></div>
        <button class="btn" id="connectBtn">连接钱包</button>
      </div>
      <div class="row" style="margin-top:8px; gap:16px;">
        <div class="muted">钱包: <span id="walletAddr">--</span></div>
        <div class="muted">网络: Berachain 主网 (80094)</div>
      </div>
    </div>

    <!-- 矿池余额卡片 -->
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-top:12px;">
      <div class="card" style="background:#1e293b;">
        <h2 style="color:#fbbf24;">💰 NFT 挖矿池余额</h2>
        <div style="font-size:28px; font-weight:700; color:#fcd34d; margin:16px 0;" id="nftPoolBalance">-- DP</div>
        <div class="muted">合约: <span id="addrNFTPool"></span></div>
        <div class="group" style="margin-top:12px;">
          <label>快速转入（DP）</label>
          <input id="nftDepositAmount" placeholder="例: 1000000" />
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" onclick="depositToNFTPool()" style="flex:1">转入</button>
          <button class="btn secondary" onclick="refreshPoolBalances()" style="flex:1">刷新</button>
        </div>
        <div class="msg" id="msgNFTPool"></div>
      </div>
      <div class="card" style="background:#1e293b;">
        <h2 style="color:#a78bfa;">⛏️ T-Engine 池余额</h2>
        <div style="font-size:28px; font-weight:700; color:#c4b5fd; margin:16px 0;" id="tenPoolBalance">-- DP</div>
        <div class="muted">合约: <span id="addrTEngineAddr"></span></div>
        <div class="group" style="margin-top:12px;">
          <label>快速转入（DP）</label>
          <input id="tenDepositAmount" placeholder="例: 1000000" />
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" onclick="depositToTEngine()" style="flex:1">转入</button>
          <button class="btn secondary" onclick="refreshPoolBalances()" style="flex:1">刷新</button>
        </div>
        <div class="msg" id="msgTEnginePool"></div>
      </div>
    </div>

    <!-- 紧急控制卡片 -->
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); margin-top:12px;">
      <!-- DPToken 控制 -->
      <div class="card" style="background:#1e293b; border:2px solid #ef4444;">
        <h2 style="color:#fca5a5;">🪙 DPToken 紧急控制</h2>
        <div class="muted" style="margin-bottom:8px;">合约: <span id="addrDPToken"></span></div>
        <div style="margin-bottom:10px;">
          <div class="stat"><span>版本</span><span id="dpVersion">--</span></div>
          <div class="stat"><span>状态</span><span id="dpPaused" style="font-weight:700;">--</span></div>
          <div class="stat"><span>总供应量</span><span id="dpTotalSupply">--</span></div>
          <div class="stat"><span>最大供应</span><span id="dpMaxSupply">--</span></div>
          <div class="stat"><span>供应比例</span><span id="dpSupplyRatio">--</span></div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn danger" id="btnDPPause" style="flex:1">暂停 DPToken</button>
          <button class="btn secondary" id="btnDPUnpause" style="flex:1">恢复 DPToken</button>
        </div>
        <div class="msg" id="msgDPToken"></div>
      </div>

      <!-- DebearPass 控制 -->
      <div class="card" style="background:#1e293b; border:2px solid #f59e0b;">
        <h2 style="color:#fbbf24;">🎫 DebearPass 紧急控制</h2>
        <div class="muted" style="margin-bottom:8px;">合约: <span id="addrDebearPass"></span></div>
        <div style="margin-bottom:10px;">
          <div class="stat"><span>版本</span><span id="passVersion">--</span></div>
          <div class="stat"><span>状态</span><span id="passPaused" style="font-weight:700;">--</span></div>
          <div class="stat"><span>Standard Pass</span><span id="passStandard">--</span></div>
          <div class="stat"><span>Premium Pass</span><span id="passPremium">--</span></div>
          <div class="stat"><span>Exclusive Pass</span><span id="passExclusive">--</span></div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn warning" id="btnPassPause" style="flex:1">暂停 Pass</button>
          <button class="btn secondary" id="btnPassUnpause" style="flex:1">恢复 Pass</button>
        </div>
        <div class="msg" id="msgDebearPass"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Pass 销售控制 -->
      <div class="card">
        <h2>🎫 Pass 销售</h2>
        <div class="muted" style="margin-bottom:8px;">合约: <span id="addrPassSale"></span></div>
        <div class="group">
          <label>价格（BERA）</label>
          <div class="row">
            <input id="priceStd" placeholder="Standard 例: 0.10" style="flex:1" />
            <input id="pricePre" placeholder="Premium 例: 0.30" style="flex:1" />
            <input id="priceEx" placeholder="Exclusive 例: 0.50" style="flex:1" />
          </div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" id="btnSetPrices">设置价格</button>
          <div class="switch">
            <input type="checkbox" id="saleActiveSwitch" />
            <label for="saleActiveSwitch">销售开关</label>
          </div>
        </div>
        <div class="msg" id="msgPassSale"></div>
        <div style="margin-top:10px;">
          <div class="stat"><span>当前价格</span><span id="currPrices">--</span></div>
          <div class="stat"><span>销售状态</span><span id="currSaleActive">--</span></div>
          <div class="stat"><span>总销售额</span><span id="currTotalSales">--</span></div>
          <div class="stat"><span>已售数量</span><span id="currSoldCount">--</span></div>
        </div>
      </div>

      <!-- NFT 挖矿控制 -->
      <div class="card">
        <h2>🎨 NFT 挖矿</h2>
        <div class="muted" style="margin-bottom:8px;">合约: <span id="addrNFTMining"></span></div>
        <div class="group">
          <label>基础日产出（DP/天）</label>
          <input id="baseDailyReward" placeholder="例: 80 (将按 18 位精度转换)" />
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" id="btnSetBase">设置日产出</button>
          <div class="switch">
            <input type="checkbox" id="miningPausedSwitch" />
            <label for="miningPausedSwitch">暂停领取</label>
          </div>
        </div>
        <div class="group" style="margin-top:8px;">
          <label>Claim 税费（百分比 0-100）与接收地址</label>
          <div class="row">
            <input id="nftTaxRate" placeholder="税率 % (例: 10)" style="flex:1" />
            <input id="nftTaxRecipient" placeholder="接收地址 0x..." style="flex:2" />
          </div>
        </div>
        <button class="btn secondary" id="btnSetNftTax">设置税费</button>
        <div class="msg" id="msgNFT"></div>
        <div style="margin-top:10px;">
          <div class="stat"><span>当前日产出</span><span id="currBaseDaily">--</span></div>
          <div class="stat"><span>暂停状态</span><span id="currMiningPaused">--</span></div>
          <div class="stat"><span>税费</span><span id="currNftTax">--</span></div>
          <div class="stat"><span>累计领取</span><span id="currNftClaimed">--</span></div>
        </div>
      </div>

      <!-- T-Engine 控制 -->
      <div class="card">
        <h2>⛏️ T-Engine</h2>
        <div class="muted" style="margin-bottom:8px;">合约: <span id="addrTEngine"></span></div>
        <div class="group">
          <label>份额倍数（如 4 表示 4x）</label>
          <input id="sharesMultiplier" placeholder="例: 4" />
        </div>
        <div class="group">
          <label>每日释放率（万分比，0-10000；30=0.3%/天）</label>
          <input id="dailyReleaseRate" placeholder="例: 30" />
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" id="btnSetMultiplier">设置倍数</button>
          <button class="btn" id="btnSetDailyRate">设置每日释放</button>
          <div class="switch">
            <input type="checkbox" id="claimPausedSwitch" />
            <label for="claimPausedSwitch">暂停领取</label>
          </div>
        </div>
        <div class="group" style="margin-top:8px;">
          <label>Claim 税费（百分比 0-100）与接收地址</label>
          <div class="row">
            <input id="tenTaxRate" placeholder="税率 % (例: 10)" style="flex:1" />
            <input id="tenTaxRecipient" placeholder="接收地址 0x..." style="flex:2" />
          </div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn secondary" id="btnSetTenTaxRate">设置税率</button>
          <button class="btn secondary" id="btnSetTenTaxRecipient">设置接收地址</button>
        </div>
        <div class="msg" id="msgTEngine"></div>
        <div style="margin-top:10px;">
          <div class="stat"><span>当前倍数</span><span id="currMultiplier">--</span></div>
          <div class="stat"><span>当前每日释放</span><span id="currDailyRate">--</span></div>
          <div class="stat"><span>暂停状态</span><span id="currClaimPaused">--</span></div>
          <div class="stat"><span>税费</span><span id="currTenTax">--</span></div>
          <div class="stat"><span>矿池余额</span><span id="currTenPoolBal">--</span></div>
          <div class="stat"><span>累计销毁</span><span id="currTenDeposited">--</span></div>
          <div class="stat"><span>累计领取</span><span id="currTenClaimed">--</span></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:24px;">
      <div class="muted">提示：仅合约 Owner 可调用以上管理操作。请确保当前钱包是各合约的 owner。</div>
      <div class="muted">默认地址已从部署记录填充，若有升级或变更，请在源码内 CONTRACTS 常量中更新。</div>
    </div>
  </div>

  <script>
    // 代理地址（实际使用的地址，已升级到 v1.1.0）
    const CONTRACTS = {
      passSale: '0x40477c0B232cF7AaF939EC79d2Cad51669E101C6',      // 旧部署
      debearPass: '0x29f2a6756E5B79C36Eb6699220CB56f7749C7514',    // 旧部署
      nftMining: '0x8883Ef27fFa001fAcc323E566Bce387A63Af5B4A',     // 旧部署
      nftMiningPool: '0x0D9bfaC27128EA2754179400eB932F13B7c52097', // 旧部署
      tEngine:   '0xd9661D56659B80A875E42A51955434A0818581D8',     // 旧部署
      dpToken:   '0xf7C464c7832e59855aa245Ecc7677f54B3460e7d'      // ✅ 已升级 v1.1.0
    };

    // ABIs（仅管理所需）
    const OWNABLE_ABI = [ 'function owner() view returns (address)' ];
    const ERC20_ABI = [
      'function balanceOf(address) view returns (uint256)',
      'function transfer(address to, uint256 amount) returns (bool)'
    ];

    const PASS_SALE_ABI = [
      'function setPrices(uint256[3])',
      'function getAllPrices() view returns (uint256[3])',
      'function setSaleActive(bool)',
      'function saleActive() view returns (bool)',
      'function totalSales() view returns (uint256)',
      'function totalSoldCount() view returns (uint256)',
      'function totalInviteRewards() view returns (uint256)',
      'function owner() view returns (address)'
    ];

    const NFT_MINING_ABI = [
      'function setBaseDailyReward(uint256)',
      'function baseDailyReward() view returns (uint256)',
      'function setMiningPaused(bool)',
      'function miningPaused() view returns (bool)',
      'function setTaxConfig(uint256,address)',
      'function taxRate() view returns (uint256)',
      'function taxRecipient() view returns (address)',
      'function totalClaimed() view returns (uint256)',
      'function owner() view returns (address)'
    ];

    const TENGINE_ABI = [
      'function setSharesMultiplier(uint256)',
      'function sharesMultiplier() view returns (uint256)',
      'function setDailyReleaseRate(uint256)',
      'function dailyReleaseRate() view returns (uint256)',
      'function setClaimPaused(bool)',
      'function claimPaused() view returns (bool)',
      'function setTaxRate(uint256)',
      'function taxRate() view returns (uint256)',
      'function setTaxRecipient(address)',
      'function taxRecipient() view returns (address)',
      'function totalDeposited() view returns (uint256)',
      'function totalClaimed() view returns (uint256)',
      'function totalTaxCollected() view returns (uint256)',
      'function totalInviteRewards() view returns (uint256)',
      'function getPoolBalance() view returns (uint256)',
      'function owner() view returns (address)'
    ];

    const DPTOKEN_ABI = [
      'function pause(string reason)',
      'function unpause()',
      'function paused() view returns (bool)',
      'function totalSupply() view returns (uint256)',
      'function MAX_SUPPLY() view returns (uint256)',
      'function checkSupplyAnomaly() view returns (bool isAnomalous, uint256 currentSupply, uint256 maxSupply)',
      'function version() view returns (string)',
      'function emergencyPauser() view returns (address)',
      'function owner() view returns (address)'
    ];

    const DEBEARPASS_ABI = [
      'function pause()',
      'function unpause()',
      'function paused() view returns (bool)',
      'function passConfigs(uint256) view returns (uint256 maxSupply, uint256 totalMinted, uint256 multiplier, uint256 inviteRate)',
      'function getRemainingSupply(uint256) view returns (uint256)',
      'function version() view returns (string)',
      'function owner() view returns (address)'
    ];

    let provider, signer, user;

    // UI helpers
    const $ = (id) => document.getElementById(id);
    const setMsg = (id, text, ok=true) => { $(id).textContent = text; $(id).style.color = ok ? '#86efac' : '#fca5a5'; };

    async function connectWallet() {
      try {
        const walletProvider = window.okxwallet || window.ethereum;
        if (!walletProvider) { alert('请安装 MetaMask / OKX Wallet'); return; }
        await walletProvider.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(walletProvider);
        signer = provider.getSigner();
        user = await signer.getAddress();
        $('connectBtn').textContent = '已连接';
        $('connectBtn').disabled = true;
        $('walletAddr').textContent = `${user.slice(0,6)}...${user.slice(-4)}`;
        $('addrPassSale').textContent = CONTRACTS.passSale;
        $('addrNFTMining').textContent = CONTRACTS.nftMining;
        $('addrTEngine').textContent  = CONTRACTS.tEngine;
        $('addrNFTPool').textContent = CONTRACTS.nftMiningPool;
        $('addrTEngineAddr').textContent = CONTRACTS.tEngine;
        $('addrDPToken').textContent = CONTRACTS.dpToken;
        $('addrDebearPass').textContent = CONTRACTS.debearPass || '未配置';
        await refreshAll();
        await refreshPoolBalances();
      } catch (e) {
        console.error(e); alert('连接失败: ' + (e?.message||e));
      }
    }

    // 权限标识
    async function refreshOwnerBadges() {
      try {
        const passSale = new ethers.Contract(CONTRACTS.passSale, PASS_SALE_ABI, provider);
        const nftM = new ethers.Contract(CONTRACTS.nftMining, NFT_MINING_ABI, provider);
        const ten = new ethers.Contract(CONTRACTS.tEngine, TENGINE_ABI, provider);
        const [o1, o2, o3] = await Promise.all([passSale.owner(), nftM.owner(), ten.owner()]);
        const isAllOwner = [o1,o2,o3].every(o => o.toLowerCase() === user.toLowerCase());
        $('ownerBadge').textContent = isAllOwner ? 'Owner 已验证' : '当前非全部合约 Owner';
        $('ownerBadge').style.color = isAllOwner ? '#bbf7d0' : '#fca5a5';
      } catch { $('ownerBadge').textContent = 'Owner 未验证'; }
    }

    // 读取当前值
    async function refreshAll() {
      await refreshOwnerBadges();
      await Promise.all([
        refreshDPToken(),
        refreshDebearPass(),
        refreshPassSale(),
        refreshNFTMining(),
        refreshTEngine(),
        refreshPoolBalances()
      ]);
    }

    // 刷新矿池余额
    async function refreshPoolBalances() {
      try {
        const dpToken = new ethers.Contract(CONTRACTS.dpToken, ERC20_ABI, provider);
        const [nftBal, tenBal] = await Promise.all([
          dpToken.balanceOf(CONTRACTS.nftMiningPool),
          dpToken.balanceOf(CONTRACTS.tEngine)
        ]);
        const fmt = (bn)=> parseFloat(ethers.utils.formatEther(bn)).toLocaleString('en-US', {maximumFractionDigits:2});
        $('nftPoolBalance').textContent = `${fmt(nftBal)} DP`;
        $('tenPoolBalance').textContent = `${fmt(tenBal)} DP`;
      } catch (e) {
        console.warn('读取矿池余额失败:', e);
        $('nftPoolBalance').textContent = '读取失败';
        $('tenPoolBalance').textContent = '读取失败';
      }
    }

    async function refreshPassSale() {
      try {
        const passSale = new ethers.Contract(CONTRACTS.passSale, PASS_SALE_ABI, provider);
        const [prices, active, totalSales, soldCount] = await Promise.all([
          passSale.getAllPrices(),
          passSale.saleActive(),
          passSale.totalSales(),
          passSale.totalSoldCount()
        ]);
        const fmt = (v)=> parseFloat(ethers.utils.formatEther(v)).toFixed(3);
        $('currPrices').textContent = `Std ${fmt(prices[0])} / Pre ${fmt(prices[1])} / Ex ${fmt(prices[2])} BERA`;
        $('saleActiveSwitch').checked = !!active;
        $('currSaleActive').textContent = active ? '已开启' : '已暂停';
        $('currTotalSales').textContent = `${fmt(totalSales)} BERA`;
        $('currSoldCount').textContent = soldCount.toString() + ' 个';
        // 填充输入框（避免覆盖用户手填：仅空时填）
        if (!$('priceStd').value) $('priceStd').value = fmt(prices[0]);
        if (!$('pricePre').value) $('pricePre').value = fmt(prices[1]);
        if (!$('priceEx').value) $('priceEx').value = fmt(prices[2]);
      } catch (e) { setMsg('msgPassSale', '读取失败: ' + (e?.message||e), false); }
    }

    async function refreshNFTMining() {
      try {
        const nftM = new ethers.Contract(CONTRACTS.nftMining, NFT_MINING_ABI, provider);
        
        // 尝试读取 V2 新增方法
        let base, paused, rate, recip, claimed;
        try {
          [base, paused, rate, recip, claimed] = await Promise.all([
            nftM.baseDailyReward(),
            nftM.miningPaused(),
            nftM.taxRate(),
            nftM.taxRecipient(),
            nftM.totalClaimed()
          ]);
        } catch (v2Error) {
          console.warn('NFTMiningV2 部分方法不存在，可能未完全升级:', v2Error);
          // 尝试单独读取基础方法
          try {
            base = await nftM.baseDailyReward();
            paused = await nftM.miningPaused();
            rate = await nftM.taxRate();
            recip = await nftM.taxRecipient();
            claimed = null; // V2 新增，可能不存在
          } catch (fallbackError) {
            throw new Error('合约方法调用失败，请检查合约是否已部署/升级');
          }
        }
        
        const fmtBig = (bn)=> parseFloat(ethers.utils.formatEther(bn)).toLocaleString('en-US', {maximumFractionDigits:0});
        $('currBaseDaily').textContent = `${parseFloat(ethers.utils.formatEther(base)).toFixed(0)} DP/天`;
        $('currMiningPaused').textContent = paused ? '已暂停' : '运行中';
        $('miningPausedSwitch').checked = !!paused;
        $('currNftTax').textContent = `${rate.toString()}% / ${recip && recip !== ethers.constants.AddressZero ? recip : '未设置'}`;
        $('currNftClaimed').textContent = claimed !== null ? `${fmtBig(claimed)} DP` : '需升级';
        if (!$('baseDailyReward').value) $('baseDailyReward').value = parseFloat(ethers.utils.formatEther(base)).toFixed(0);
        if (!$('nftTaxRate').value) $('nftTaxRate').value = rate.toString();
        if (!$('nftTaxRecipient').value && recip && recip !== ethers.constants.AddressZero) $('nftTaxRecipient').value = recip;
      } catch (e) { setMsg('msgNFT', '读取失败: ' + (e?.message||e), false); }
    }

    async function refreshTEngine() {
      try {
        const ten = new ethers.Contract(CONTRACTS.tEngine, TENGINE_ABI, provider);
        
        // 所有方法都应该在最新版本中存在
        const [mul, daily, paused, rate, recip, poolBal, deposited, claimed] = await Promise.all([
          ten.sharesMultiplier(),
          ten.dailyReleaseRate(),
          ten.claimPaused(),
          ten.taxRate(),
          ten.taxRecipient(),
          ten.getPoolBalance(),
          ten.totalDeposited(),
          ten.totalClaimed()
        ]);
        
        const fmtBig = (bn)=> parseFloat(ethers.utils.formatEther(bn)).toLocaleString('en-US', {maximumFractionDigits:0});
        $('currMultiplier').textContent = mul.toString() + 'x';
        $('currDailyRate').textContent = `${daily.toString()} (万分比)`;
        $('currClaimPaused').textContent = paused ? '已暂停' : '运行中';
        $('claimPausedSwitch').checked = !!paused;
        $('currTenTax').textContent = `${rate.toString()}% / ${recip}`;
        $('currTenPoolBal').textContent = `${fmtBig(poolBal)} DP`;
        $('currTenDeposited').textContent = `${fmtBig(deposited)} DP`;
        $('currTenClaimed').textContent = `${fmtBig(claimed)} DP`;
        if (!$('sharesMultiplier').value) $('sharesMultiplier').value = mul.toString();
        if (!$('dailyReleaseRate').value) $('dailyReleaseRate').value = daily.toString();
        if (!$('tenTaxRate').value) $('tenTaxRate').value = rate.toString();
        if (!$('tenTaxRecipient').value) $('tenTaxRecipient').value = recip;
      } catch (e) { 
        console.warn('TEngine 读取失败:', e);
        setMsg('msgTEngine', '读取失败: ' + (e?.message||e), false); 
      }
    }

    // 写操作
    async function withSigner(addr, abi) {
      if (!signer) throw new Error('请先连接钱包');
      return new ethers.Contract(addr, abi, signer);
    }

    // PassSale
    $('btnSetPrices').onclick = async () => {
      try {
        const passSale = await withSigner(CONTRACTS.passSale, PASS_SALE_ABI);
        const p1 = ethers.utils.parseEther(($('priceStd').value || '0').trim());
        const p2 = ethers.utils.parseEther(($('pricePre').value || '0').trim());
        const p3 = ethers.utils.parseEther(($('priceEx').value || '0').trim());
        const tx = await passSale.setPrices([p1, p2, p3]);
        setMsg('msgPassSale', '提交交易中...');
        await tx.wait();
        setMsg('msgPassSale', '价格已更新');
        await refreshPassSale();
      } catch (e) { setMsg('msgPassSale', e?.message||String(e), false); }
    };

    $('saleActiveSwitch').onchange = async (e) => {
      try {
        const passSale = await withSigner(CONTRACTS.passSale, PASS_SALE_ABI);
        const tx = await passSale.setSaleActive(e.target.checked);
        setMsg('msgPassSale', '提交交易中...');
        await tx.wait();
        setMsg('msgPassSale', '销售状态已更新');
        await refreshPassSale();
      } catch (e2) { setMsg('msgPassSale', e2?.message||String(e2), false); await refreshPassSale(); }
    };

    // NFT Mining
    $('btnSetBase').onclick = async () => {
      try {
        const nftM = await withSigner(CONTRACTS.nftMining, NFT_MINING_ABI);
        const v = $('baseDailyReward').value.trim();
        const wei = ethers.utils.parseEther(v || '0');
        const tx = await nftM.setBaseDailyReward(wei);
        setMsg('msgNFT', '提交交易中...');
        await tx.wait();
        setMsg('msgNFT', '基础日产出已更新');
        await refreshNFTMining();
      } catch (e) { setMsg('msgNFT', e?.message||String(e), false); }
    };

    $('miningPausedSwitch').onchange = async (e) => {
      try {
        const nftM = await withSigner(CONTRACTS.nftMining, NFT_MINING_ABI);
        const tx = await nftM.setMiningPaused(e.target.checked);
        setMsg('msgNFT', '提交交易中...');
        await tx.wait();
        setMsg('msgNFT', '暂停状态已更新');
        await refreshNFTMining();
      } catch (e2) { setMsg('msgNFT', e2?.message||String(e2), false); await refreshNFTMining(); }
    };

    $('btnSetNftTax').onclick = async () => {
      try {
        const rate = parseInt(($('nftTaxRate').value||'0').trim(), 10);
        const recip = ($('nftTaxRecipient').value||'').trim();
        const nftM = await withSigner(CONTRACTS.nftMining, NFT_MINING_ABI);
        const tx = await nftM.setTaxConfig(rate, recip);
        setMsg('msgNFT', '提交交易中...');
        await tx.wait();
        setMsg('msgNFT', '税费配置已更新');
        await refreshNFTMining();
      } catch (e) { setMsg('msgNFT', e?.message||String(e), false); }
    };

    // TEngine
    $('btnSetMultiplier').onclick = async () => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const mul = parseInt(($('sharesMultiplier').value||'0').trim(), 10);
        const tx = await ten.setSharesMultiplier(mul);
        setMsg('msgTEngine', '提交交易中...');
        await tx.wait();
        setMsg('msgTEngine', '倍数已更新');
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    $('btnSetDailyRate').onclick = async () => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const rate = parseInt(($('dailyReleaseRate').value||'0').trim(), 10);
        const tx = await ten.setDailyReleaseRate(rate);
        setMsg('msgTEngine', '提交交易中...');
        await tx.wait();
        setMsg('msgTEngine', '每日释放率已更新');
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    $('claimPausedSwitch').onchange = async (e) => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const tx = await ten.setClaimPaused(e.target.checked);
        setMsg('msgTEngine', '提交交易中...');
        await tx.wait();
        setMsg('msgTEngine', '暂停状态已更新');
        await refreshTEngine();
      } catch (e2) { setMsg('msgTEngine', e2?.message||String(e2), false); await refreshTEngine(); }
    };

    $('btnSetTenTaxRate').onclick = async () => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const rate = parseInt(($('tenTaxRate').value||'0').trim(), 10);
        const tx = await ten.setTaxRate(rate);
        setMsg('msgTEngine', '提交交易中...');
        await tx.wait();
        setMsg('msgTEngine', '税率已更新');
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    $('btnSetTenTaxRecipient').onclick = async () => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const recip = ($('tenTaxRecipient').value||'').trim();
        const tx = await ten.setTaxRecipient(recip);
        setMsg('msgTEngine', '提交交易中...');
        await tx.wait();
        setMsg('msgTEngine', '税费接收地址已更新');
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    // DPToken 控制
    async function refreshDPToken() {
      try {
        const dpToken = new ethers.Contract(CONTRACTS.dpToken, DPTOKEN_ABI, provider);
        
        // 尝试读取 V2 方法（paused, version）
        let paused, version;
        try {
          [paused, version] = await Promise.all([
            dpToken.paused(),
            dpToken.version()
          ]);
        } catch (v2Error) {
          // V2 方法不存在，说明未升级
          console.warn('DPToken 未升级到 V2，暂停功能不可用');
          paused = null;
          version = 'V1 (未升级)';
        }
        
        // 读取基础信息（V1 已有）
        let totalSupply, maxSupply;
        try {
          totalSupply = await dpToken.totalSupply();
        } catch (supplyError) {
          console.warn('无法读取 totalSupply，合约可能未正确部署');
          throw new Error('合约地址无效或未部署');
        }
        
        // MAX_SUPPLY 可能不存在于某些旧版本
        try {
          maxSupply = await dpToken.MAX_SUPPLY();
        } catch (maxSupplyError) {
          console.warn('MAX_SUPPLY 不存在，使用默认值 10 亿');
          maxSupply = ethers.utils.parseEther('1000000000'); // 10 亿 DP
        }
        
        const fmt = (bn) => parseFloat(ethers.utils.formatEther(bn)).toLocaleString('en-US', {maximumFractionDigits:0});
        $('dpVersion').textContent = version;
        
        if (paused !== null) {
          $('dpPaused').textContent = paused ? '⛸️ 已暂停' : '✅ 运行中';
          $('dpPaused').style.color = paused ? '#fca5a5' : '#86efac';
          $('btnDPPause').disabled = paused;
          $('btnDPUnpause').disabled = !paused;
        } else {
          $('dpPaused').textContent = '🔄 需升级到 V2';
          $('dpPaused').style.color = '#fbbf24';
          $('btnDPPause').disabled = true;
          $('btnDPUnpause').disabled = true;
        }
        
        $('dpTotalSupply').textContent = `${fmt(totalSupply)} DP`;
        $('dpMaxSupply').textContent = `${fmt(maxSupply)} DP`;
        const ratio = (parseFloat(ethers.utils.formatEther(totalSupply)) / parseFloat(ethers.utils.formatEther(maxSupply)) * 100).toFixed(2);
        $('dpSupplyRatio').textContent = `${ratio}%`;
      } catch (e) {
        console.warn('DPToken 读取失败:', e);
        // 显示友好的错误信息
        $('dpVersion').textContent = '读取失败';
        $('dpPaused').textContent = '❌ 无法连接';
        $('dpPaused').style.color = '#ef4444';
        $('dpTotalSupply').textContent = '--';
        $('dpMaxSupply').textContent = '--';
        $('dpSupplyRatio').textContent = '--';
        $('btnDPPause').disabled = true;
        $('btnDPUnpause').disabled = true;
        setMsg('msgDPToken', '⚠️ 合约地址可能有误，请检查配置', false);
      }
    }

    async function refreshDebearPass() {
      if (!CONTRACTS.debearPass) {
        $('passVersion').textContent = '未配置';
        $('passPaused').textContent = '--';
        return;
      }
      try {
        const debearPass = new ethers.Contract(CONTRACTS.debearPass, DEBEARPASS_ABI, provider);
        
        // 尝试读取 V2 方法（paused, version）
        let paused, version;
        try {
          [paused, version] = await Promise.all([
            debearPass.paused(),
            debearPass.version()
          ]);
        } catch (v2Error) {
          console.warn('DebearPass 未升级到 V2，暂停功能不可用');
          paused = null;
          version = 'V1 (未升级)';
        }
        
        // 读取 Pass 配置（V1 已有）
        const [std, pre, ex] = await Promise.all([
          debearPass.passConfigs(1),
          debearPass.passConfigs(2),
          debearPass.passConfigs(3)
        ]);
        
        $('passVersion').textContent = version;
        
        if (paused !== null) {
          $('passPaused').textContent = paused ? '⛸️ 已暂停' : '✅ 运行中';
          $('passPaused').style.color = paused ? '#fca5a5' : '#86efac';
          $('btnPassPause').disabled = paused;
          $('btnPassUnpause').disabled = !paused;
        } else {
          $('passPaused').textContent = '🔄 需升级到 V2';
          $('passPaused').style.color = '#fbbf24';
          $('btnPassPause').disabled = true;
          $('btnPassUnpause').disabled = true;
        }
        
        $('passStandard').textContent = `${std.totalMinted}/${std.maxSupply} (剩余 ${std.maxSupply - std.totalMinted})`;
        $('passPremium').textContent = `${pre.totalMinted}/${pre.maxSupply} (剩余 ${pre.maxSupply - pre.totalMinted})`;
        $('passExclusive').textContent = `${ex.totalMinted}/${ex.maxSupply} (剩余 ${ex.maxSupply - ex.totalMinted})`;
      } catch (e) {
        console.warn('DebearPass 读取失败:', e);
        setMsg('msgDebearPass', '读取失败: ' + (e?.message||e), false);
      }
    }

    $('btnDPPause').onclick = async () => {
      const reason = prompt('请输入暂停原因:');
      if (!reason) return;
      try {
        const dpToken = await withSigner(CONTRACTS.dpToken, DPTOKEN_ABI);
        const tx = await dpToken.pause(reason);
        setMsg('msgDPToken', '提交交易中...');
        await tx.wait();
        setMsg('msgDPToken', '✅ DPToken 已暂停');
        await refreshDPToken();
      } catch (e) { setMsg('msgDPToken', e?.message||String(e), false); }
    };

    $('btnDPUnpause').onclick = async () => {
      if (!confirm('确定要恢复 DPToken 吗？')) return;
      try {
        const dpToken = await withSigner(CONTRACTS.dpToken, DPTOKEN_ABI);
        const tx = await dpToken.unpause();
        setMsg('msgDPToken', '提交交易中...');
        await tx.wait();
        setMsg('msgDPToken', '✅ DPToken 已恢复');
        await refreshDPToken();
      } catch (e) { setMsg('msgDPToken', e?.message||String(e), false); }
    };

    $('btnPassPause').onclick = async () => {
      if (!confirm('确定要暂停 DebearPass 吗？')) return;
      try {
        const debearPass = await withSigner(CONTRACTS.debearPass, DEBEARPASS_ABI);
        const tx = await debearPass.pause();
        setMsg('msgDebearPass', '提交交易中...');
        await tx.wait();
        setMsg('msgDebearPass', '✅ DebearPass 已暂停');
        await refreshDebearPass();
      } catch (e) { setMsg('msgDebearPass', e?.message||String(e), false); }
    };

    $('btnPassUnpause').onclick = async () => {
      if (!confirm('确定要恢复 DebearPass 吗？')) return;
      try {
        const debearPass = await withSigner(CONTRACTS.debearPass, DEBEARPASS_ABI);
        const tx = await debearPass.unpause();
        setMsg('msgDebearPass', '提交交易中...');
        await tx.wait();
        setMsg('msgDebearPass', '✅ DebearPass 已恢复');
        await refreshDebearPass();
      } catch (e) { setMsg('msgDebearPass', e?.message||String(e), false); }
    };

    // 快速转入 NFT 池
    async function depositToNFTPool() {
      try {
        const amt = ($('nftDepositAmount').value||'').trim();
        if (!amt || parseFloat(amt) <= 0) { setMsg('msgNFTPool', '请输入有效数量', false); return; }
        const dp = await withSigner(CONTRACTS.dpToken, ERC20_ABI);
        const wei = ethers.utils.parseEther(amt);
        setMsg('msgNFTPool', '提交交易中...');
        const tx = await dp.transfer(CONTRACTS.nftMiningPool, wei);
        await tx.wait();
        setMsg('msgNFTPool', '转入成功');
        $('nftDepositAmount').value = '';
        await refreshPoolBalances();
      } catch (e) { setMsg('msgNFTPool', e?.message||String(e), false); }
    }

    // 快速转入 T-Engine 池
    async function depositToTEngine() {
      try {
        const amt = ($('tenDepositAmount').value||'').trim();
        if (!amt || parseFloat(amt) <= 0) { setMsg('msgTEnginePool', '请输入有效数量', false); return; }
        const dp = await withSigner(CONTRACTS.dpToken, ERC20_ABI);
        const wei = ethers.utils.parseEther(amt);
        setMsg('msgTEnginePool', '提交交易中...');
        const tx = await dp.transfer(CONTRACTS.tEngine, wei);
        await tx.wait();
        setMsg('msgTEnginePool', '转入成功');
        $('tenDepositAmount').value = '';
        await refreshPoolBalances();
      } catch (e) { setMsg('msgTEnginePool', e?.message||String(e), false); }
    }

    // Bind connect button
    $('connectBtn').onclick = connectWallet;
  </script>
</body>
</html>
