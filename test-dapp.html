<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debear Party - å®Œæ•´æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn:hover { background: #5568d3; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn.secondary { background: #48bb78; }
        .btn.secondary:hover { background: #38a169; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #2d3748;
            margin-bottom: 16px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .stat:last-child { border-bottom: none; }
        .stat-label {
            color: #718096;
            font-size: 14px;
        }
        .stat-value {
            font-weight: 600;
            color: #2d3748;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .alert.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
        }
        .alert.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }
        .alert.info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #3182ce;
        }
        .pass-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        .pass-item {
            text-align: center;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .pass-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .pass-item.selected {
            border-color: #667eea;
            background: #f7fafc;
        }
        .pass-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }
        .pass-price {
            color: #667eea;
            font-size: 18px;
            font-weight: 700;
        }
        .pass-multiplier {
            color: #718096;
            font-size: 12px;
            margin-top: 4px;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .hidden { display: none; }
        .reward-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 16px 0;
        }
        .reward-amount {
            font-size: 32px;
            font-weight: 700;
            margin: 8px 0;
        }
        .reward-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ¯ Debear Party - å®Œæ•´ç³»ç»Ÿæµ‹è¯•</h1>
            <p style="color: #718096; margin-top: 8px;">Berachain ä¸»ç½‘ (Chain ID: 80094)</p>
            <div class="wallet-info">
                <div>
                    <div id="walletAddress" style="color: #2d3748; font-weight: 600;">æœªè¿æ¥é’±åŒ…</div>
                    <div id="beraBalance" style="color: #718096; font-size: 14px; margin-top: 4px;">BERA: --</div>
                    <div id="dpBalance" style="color: #718096; font-size: 14px;">DP: --</div>
                </div>
                <button id="connectBtn" class="btn">è¿æ¥é’±åŒ…</button>
            </div>
        </div>

        <div id="message"></div>

        <!-- ä¸»è¦åŠŸèƒ½åŒºåŸŸ -->
        <div class="grid">
            <!-- 1. Passè´­ä¹° -->
            <div class="card">
                <h2>ğŸ« è´­ä¹° Pass</h2>
                <div class="pass-grid">
                    <div class="pass-item" onclick="selectPass(1)">
                        <div class="pass-name">Standard</div>
                        <div class="pass-price" id="passPriceStd">-- BERA</div>
                        <div class="pass-multiplier">1x ç®—åŠ›</div>
                    </div>
                    <div class="pass-item" onclick="selectPass(2)">
                        <div class="pass-name">Premium</div>
                        <div class="pass-price" id="passPricePre">-- BERA</div>
                        <div class="pass-multiplier">3.5x ç®—åŠ›</div>
                    </div>
                    <div class="pass-item" onclick="selectPass(3)">
                        <div class="pass-name">Exclusive</div>
                        <div class="pass-price" id="passPriceEx">-- BERA</div>
                        <div class="pass-multiplier">7x ç®—åŠ›</div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label>é‚€è¯·äººåœ°å€ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="inviterInput" placeholder="0x...">
                </div>
                <button class="btn" onclick="buyPass()" style="width: 100%;">è´­ä¹° Pass</button>
                <div id="passInfo" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                    <div class="stat">
                        <span class="stat-label">Standard Pass:</span>
                        <span class="stat-value" id="standardCount">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Premium Pass:</span>
                        <span class="stat-value" id="premiumCount">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Exclusive Pass:</span>
                        <span class="stat-value" id="exclusiveCount">0</span>
                    </div>
                </div>
            </div>

            <!-- 2. é‚€è¯·å…³ç³» -->
            <div class="card">
                <h2>ğŸ¤ é‚€è¯·å…³ç³»</h2>
                <div class="stat">
                    <span class="stat-label">æˆ‘çš„é‚€è¯·äºº:</span>
                    <span class="stat-value" id="myInviter">--</span>
                </div>
                <div class="stat">
                    <span class="stat-label">æˆ‘çš„é‚€è¯·ç :</span>
                    <span class="stat-value" id="myInviteCode" style="font-size: 12px;">--</span>
                </div>
                <div class="stat">
                    <span class="stat-label">å·²é‚€è¯·äººæ•°:</span>
                    <span class="stat-value" id="inviteeCount">0</span>
                </div>
                <button class="btn secondary" onclick="refreshInviteInfo()" style="width: 100%; margin-top: 16px;">åˆ·æ–°é‚€è¯·ä¿¡æ¯</button>
            </div>

            <!-- 3. TEngine æŒ–çŸ¿ -->
            <div class="card">
                <h2>â›ï¸ TEngine è´¨æŠ¼æŒ–çŸ¿</h2>
                <div class="form-group">
                    <label>è´¨æŠ¼æ•°é‡ (DP)</label>
                    <input type="number" id="stakeAmount" placeholder="è¾“å…¥è´¨æŠ¼æ•°é‡">
                </div>
                <button class="btn" onclick="enterPool()" style="width: 100%; margin-bottom: 12px;">è¿›å…¥çŸ¿æ± </button>
                
                <div class="reward-box">
                    <div class="reward-label">å¯é¢†å–å¥–åŠ±</div>
                    <div class="reward-amount" id="tengineReward">0.0000</div>
                    <div class="reward-label">DP</div>
                </div>
                
                <button class="btn secondary" onclick="claimTengineReward()" style="width: 100%;">é¢†å–å¥–åŠ±</button>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                    <div class="stat">
                        <span class="stat-label">å·²è´¨æŠ¼:</span>
                        <span class="stat-value" id="stakedAmount">0 DP</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">å·²é¢†å–ä»½é¢:</span>
                        <span class="stat-value" id="tengineClaimedTotal">0 DP</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">å‰©ä½™ä»½é¢:</span>
                        <span class="stat-value" id="tengineRemainingShares">0 DP</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">é‡Šæ”¾è¿›åº¦:</span>
                        <span class="stat-value" id="tengineProgress">0%</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">ä¸‹æ¬¡é‡Šæ”¾å€’è®¡æ—¶:</span>
                        <span class="stat-value" id="tengineNextRelease">--:--:--</span>
                    </div>
                </div>
            </div>

            <!-- 4. NFTæŒ–çŸ¿ -->
            <div class="card">
                <h2>ğŸ¨ NFT Pass æŒ–çŸ¿</h2>
                <div class="alert info">
                    æŒæœ‰Passè‡ªåŠ¨æŒ–çŸ¿ï¼Œæ— éœ€è´¨æŠ¼ï¼
                </div>
                
                <button class="btn" onclick="initNFTMining()" style="width: 100%; margin-bottom: 12px;">åˆå§‹åŒ–æŒ–çŸ¿</button>
                
                <div class="reward-box">
                    <div class="reward-label">å¯é¢†å–å¥–åŠ±</div>
                    <div class="reward-amount" id="nftReward">0.0000</div>
                    <div class="reward-label">DP</div>
                </div>
                
                <button class="btn secondary" onclick="claimNFTReward()" style="width: 100%;">é¢†å–å¥–åŠ±</button>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                    <div class="stat">
                        <span class="stat-label">æ¯æ—¥äº§å‡º:</span>
                        <span class="stat-value" id="nftDailyReward">0 DP/å¤©</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">ç´¯è®¡å·²é¢†:</span>
                        <span class="stat-value" id="nftClaimedTotal">0 DP</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">ä¸Šæ¬¡é¢†å–:</span>
                        <span class="stat-value" id="nftLastClaim">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¼€å‘è€…å…¥å£ï¼ˆä»…ownerå¯è§ï¼‰ -->
        <div id="devEntrance" style="display: none; justify-content: center; align-items: center; margin-top: 30px; padding-bottom: 30px;">
            <a href="admin.html" style="text-decoration: none;">
                <button class="btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); font-size: 16px; padding: 15px 40px; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);">
                    ğŸ”§ å¼€å‘è€…ç®¡ç†é¢æ¿
                </button>
            </a>
        </div>
    </div>

    <script>
        // åˆçº¦åœ°å€
        const CONTRACTS = {
            dpToken: '0xf7C464c7832e59855aa245Ecc7677f54B3460e7d',
            debearPass: '0x29f2a6756E5B79C36Eb6699220CB56f7749C7514',
            invitationSystem: '0xAa733E91132dF624f391f1B426F56BD231486774',
            passSale: '0x40477c0B232cF7AaF939EC79d2Cad51669E101C6',
            tEngine: '0xd9661D56659B80A875E42A51955434A0818581D8',
            nftMiningPool: '0x0D9bfaC27128EA2754179400eB932F13B7c52097',
            nftMining: '0x8883Ef27fFa001fAcc323E566Bce387A63Af5B4A'
        };

        // ABIs (ç®€åŒ–ç‰ˆ)
        const ERC20_ABI = [
            'function balanceOf(address) view returns (uint256)',
            'function approve(address spender, uint256 amount) returns (bool)',
            'function allowance(address owner, address spender) view returns (uint256)'
        ];

        const PASS_ABI = [
            'function balanceOf(address,uint256) view returns (uint256)'
        ];

        const PASS_SALE_ABI = [
            'function buyPass(uint256 passLevel, address inviter) payable',
            'function getAllPrices() view returns (uint256[3])',
            'function saleActive() view returns (bool)'
        ];

        const INVITATION_ABI = [
            'function getInviter(address) view returns (address)',
            'function inviteeCount(address) view returns (uint256)'
        ];

        const TENGINE_ABI = [
            'function enterPool(uint256 amount, address inviter)',
            'function claim()',
            'function userInfo(address) view returns (uint256 totalShares, uint256 claimedShares, uint256 lastClaimEpoch, uint256 pendingRewards)',
            'function totalDeposited() view returns (uint256)',
            'function totalClaimed() view returns (uint256)',
            'function deployTime() view returns (uint256)',
            'function getCurrentEpoch() view returns (uint256)'
        ];

        const NFT_MINING_ABI = [
            'function initializeMining()',
            'function claimNFTReward()',
            'function getUserMiningInfo(address) view returns (uint256,uint256,uint256,uint256,uint256,uint256,uint256)',
            'function getPassCounts(address) view returns (uint256,uint256,uint256)',
            'function getTotalDailyReward(address) view returns (uint256)'
        ];

        let provider, signer, userAddress;
        let selectedPassLevel = 1;
        let updateInterval, tengineCountdownInterval;
        let passPricesWei = [null, null, null];
        let passSaleActive = false;
        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showMessage('è¯·å®‰è£… MetaMask æˆ– OKX Walletï¼', 'error');
                    return;
                }

                const walletProvider = window.okxwallet || window.ethereum;
                
                await walletProvider.request({ method: 'eth_requestAccounts' });
                
                const chainId = await walletProvider.request({ method: 'eth_chainId' });
                if (chainId !== '0x138de') {
                    try {
                        await walletProvider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x138de' }]
                        });
                    } catch (error) {
                        showMessage('è¯·åˆ‡æ¢åˆ° Berachain ä¸»ç½‘ (Chain ID: 80094)', 'error');
                        return;
                    }
                }

                provider = new ethers.providers.Web3Provider(walletProvider);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                document.getElementById('connectBtn').textContent = 'å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('walletAddress').textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;

                await refreshAllData();
                await refreshPassSaleInfo();
                startRealtimeUpdate();
                checkAndShowDevEntrance();

                showMessage('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error(error);
                showMessage('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é€‰æ‹©Pass
        function selectPass(level) {
            selectedPassLevel = level;
            document.querySelectorAll('.pass-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelectorAll('.pass-item')[level - 1].classList.add('selected');
        }

        // è´­ä¹°Pass
        async function buyPass() {
            if (!signer) {
                showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            try {
                const inviterInput = document.getElementById('inviterInput').value.trim();
                const inviter = inviterInput || '0xd8B4286c2f299220830f7228bab15225b4EA8379';

                if (!passSaleActive) {
                    showMessage('å½“å‰é”€å”®æœªå¼€å¯', 'error');
                    return;
                }
                const priceWei = passPricesWei[selectedPassLevel - 1];
                if (!priceWei) {
                    await refreshPassSaleInfo();
                }

                const passSale = new ethers.Contract(CONTRACTS.passSale, PASS_SALE_ABI, signer);
                showMessage('æ­£åœ¨è´­ä¹° Pass...', 'info');
                const tx = await passSale.buyPass(selectedPassLevel, inviter, {
                    value: priceWei || passPricesWei[selectedPassLevel - 1]
                });
                await tx.wait();
                showMessage('Pass è´­ä¹°æˆåŠŸï¼', 'success');
                await refreshAllData();
                await refreshPassSaleInfo();
            } catch (error) {
                console.error(error);
                showMessage('è´­ä¹°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è¿›å…¥çŸ¿æ± 
        async function enterPool() {
            if (!signer) return;

            try {
                const amount = document.getElementById('stakeAmount').value;
                if (!amount || amount <= 0) {
                    showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è´¨æŠ¼æ•°é‡', 'error');
                    return;
                }

                const amountWei = ethers.utils.parseEther(amount);
                const dpToken = new ethers.Contract(CONTRACTS.dpToken, ERC20_ABI, signer);
                const tEngine = new ethers.Contract(CONTRACTS.tEngine, TENGINE_ABI, signer);

                // æ£€æŸ¥æˆæƒ
                const allowance = await dpToken.allowance(userAddress, CONTRACTS.tEngine);
                if (allowance.lt(amountWei)) {
                    showMessage('æ­£åœ¨æˆæƒ...', 'info');
                    const approveTx = await dpToken.approve(CONTRACTS.tEngine, ethers.constants.MaxUint256);
                    await approveTx.wait();
                }

                // é»˜è®¤é‚€è¯·äººä½¿ç”¨ deployer åœ°å€
                const inviter = '0xd8B4286c2f299220830f7228bab15225b4EA8379';
                
                showMessage('æ­£åœ¨è´¨æŠ¼...', 'info');
                const tx = await tEngine.enterPool(amountWei, inviter);
                await tx.wait();
                
                showMessage('è´¨æŠ¼æˆåŠŸï¼', 'success');
                await refreshAllData();
            } catch (error) {
                console.error(error);
                showMessage('è´¨æŠ¼å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¢†å–TEngineå¥–åŠ±
        async function claimTengineReward() {
            if (!signer) return;

            try {
                const tEngine = new ethers.Contract(CONTRACTS.tEngine, TENGINE_ABI, signer);
                
                showMessage('æ­£åœ¨é¢†å–...', 'info');
                const tx = await tEngine.claim();
                await tx.wait();
                
                showMessage('é¢†å–æˆåŠŸï¼', 'success');
                await refreshAllData();
            } catch (error) {
                console.error(error);
                showMessage('é¢†å–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå§‹åŒ–NFTæŒ–çŸ¿
        async function initNFTMining() {
            if (!signer) return;

            try {
                const nftMining = new ethers.Contract(CONTRACTS.nftMining, NFT_MINING_ABI, signer);
                
                showMessage('æ­£åœ¨åˆå§‹åŒ–...', 'info');
                const tx = await nftMining.initializeMining();
                await tx.wait();
                
                showMessage('åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                await refreshAllData();
            } catch (error) {
                console.error(error);
                showMessage('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¢†å–NFTå¥–åŠ±
        async function claimNFTReward() {
            if (!signer) return;

            try {
                const nftMining = new ethers.Contract(CONTRACTS.nftMining, NFT_MINING_ABI, signer);
                
                showMessage('æ­£åœ¨é¢†å–...', 'info');
                const tx = await nftMining.claimNFTReward();
                await tx.wait();
                
                showMessage('é¢†å–æˆåŠŸï¼', 'success');
                await refreshAllData();
            } catch (error) {
                console.error(error);
                showMessage('é¢†å–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAllData() {
            if (!signer) return;

            try {
                // ä½™é¢
                const beraBalance = await provider.getBalance(userAddress);
                document.getElementById('beraBalance').textContent = `BERA: ${parseFloat(ethers.utils.formatEther(beraBalance)).toFixed(4)}`;

                const dpToken = new ethers.Contract(CONTRACTS.dpToken, ERC20_ABI, provider);
                const dpBalance = await dpToken.balanceOf(userAddress);
                document.getElementById('dpBalance').textContent = `DP: ${parseFloat(ethers.utils.formatEther(dpBalance)).toFixed(2)}`;

                // PassæŒæœ‰
                const passNFT = new ethers.Contract(CONTRACTS.debearPass, PASS_ABI, provider);
                const [standard, premium, exclusive] = await Promise.all([
                    passNFT.balanceOf(userAddress, 1),
                    passNFT.balanceOf(userAddress, 2),
                    passNFT.balanceOf(userAddress, 3)
                ]);
                document.getElementById('standardCount').textContent = standard.toString();
                document.getElementById('premiumCount').textContent = premium.toString();
                document.getElementById('exclusiveCount').textContent = exclusive.toString();

                // Pass ä»·æ ¼ & é”€å”®å¼€å…³
                await refreshPassSaleInfo();

                // é‚€è¯·ä¿¡æ¯
                await refreshInviteInfo();

                // TEngineä¿¡æ¯
                const tEngine = new ethers.Contract(CONTRACTS.tEngine, TENGINE_ABI, provider);
                try {
                    const userInfo = await tEngine.userInfo(userAddress);
                    const totalClaim = await tEngine.totalClaimed();
                    
                    // totalShares / 4 = åŸå§‹è´¨æŠ¼é‡ (ä½¿ç”¨Numberè½¬æ¢é¿å…BigIntè¿ç®—é”™è¯¯)
                    const stakedAmount = ethers.BigNumber.from(userInfo.totalShares).div(4);
                    const remainingShares = ethers.BigNumber.from(userInfo.totalShares).sub(userInfo.claimedShares);
                    
                    document.getElementById('stakedAmount').textContent = parseFloat(ethers.utils.formatEther(stakedAmount)).toFixed(2) + ' DP';
                    document.getElementById('tengineClaimedTotal').textContent = parseFloat(ethers.utils.formatEther(userInfo.claimedShares)).toFixed(2) + ' DP';
                    document.getElementById('tengineRemainingShares').textContent = parseFloat(ethers.utils.formatEther(remainingShares)).toFixed(2) + ' DP';
                    document.getElementById('tengineReward').textContent = parseFloat(ethers.utils.formatEther(userInfo.pendingRewards)).toFixed(4);
                    
                    // è®¡ç®—é‡Šæ”¾è¿›åº¦
                    if (userInfo.totalShares > 0n) {
                        const progress = (Number(userInfo.claimedShares) * 100 / Number(userInfo.totalShares)).toFixed(2);
                        document.getElementById('tengineProgress').textContent = progress + '%';
                    }

                    // è®¡ç®—ä¸‹æ¬¡é‡Šæ”¾å€’è®¡æ—¶ï¼ˆä¸åˆçº¦ Epoch å¯¹é½ï¼‰
                    try {
                        const [deployTimeBN, latestBlock] = await Promise.all([
                            tEngine.deployTime(),
                            provider.getBlock('latest')
                        ]);
                        const deployTime = Number(deployTimeBN.toString());
                        const now = Number(latestBlock.timestamp);
                        const SECONDS_PER_DAY = 86400;
                        const elapsedDays = Math.floor((now - deployTime) / SECONDS_PER_DAY);
                        const nextEpochStart = deployTime + (elapsedDays + 1) * SECONDS_PER_DAY;
                        startTengineCountdown(nextEpochStart);
                    } catch (err) {
                        console.warn('å€’è®¡æ—¶è®¡ç®—å¤±è´¥:', err);
                        document.getElementById('tengineNextRelease').textContent = '--:--:--';
                    }
                } catch (e) {
                    console.error('TEngineæŸ¥è¯¢é”™è¯¯:', e);
                }

                // NFTæŒ–çŸ¿ä¿¡æ¯
                const nftMining = new ethers.Contract(CONTRACTS.nftMining, NFT_MINING_ABI, provider);
                try {
                    const miningInfo = await nftMining.getUserMiningInfo(userAddress);
                    const dailyReward = await nftMining.getTotalDailyReward(userAddress);
                    
                    document.getElementById('nftDailyReward').textContent = parseFloat(ethers.utils.formatEther(dailyReward)).toFixed(0) + ' DP/å¤©';
                    document.getElementById('nftClaimedTotal').textContent = parseFloat(ethers.utils.formatEther(miningInfo[5])).toFixed(2) + ' DP';
                    document.getElementById('nftReward').textContent = parseFloat(ethers.utils.formatEther(miningInfo[4])).toFixed(4);
                    
                    if (Number(miningInfo[6]) > 0) {
                        const lastClaim = new Date(Number(miningInfo[6]) * 1000);
                        document.getElementById('nftLastClaim').textContent = lastClaim.toLocaleString('zh-CN');
                    }
                } catch (e) {
                    console.error('NFTæŒ–çŸ¿æŸ¥è¯¢é”™è¯¯:', e);
                }

            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
            }
        }

        // åˆ·æ–° Pass é”€å”®ä»·æ ¼ä¸çŠ¶æ€ï¼ˆå®æ—¶ä»é“¾ä¸Šï¼‰
        async function refreshPassSaleInfo() {
            try {
                const passSale = new ethers.Contract(CONTRACTS.passSale, PASS_SALE_ABI, provider);
                const [prices, active] = await Promise.all([
                    passSale.getAllPrices(),
                    passSale.saleActive()
                ]);
                passSaleActive = !!active;
                passPricesWei = prices;
                const fmt = (bn)=> parseFloat(ethers.utils.formatEther(bn)).toFixed(3);
                document.getElementById('passPriceStd').textContent = `${fmt(prices[0])} BERA`;
                document.getElementById('passPricePre').textContent = `${fmt(prices[1])} BERA`;
                document.getElementById('passPriceEx').textContent = `${fmt(prices[2])} BERA`;
            } catch (e) {
                console.warn('è·å– Pass ä»·æ ¼å¤±è´¥:', e);
            }
        }

        // åˆ·æ–°é‚€è¯·ä¿¡æ¯
        async function refreshInviteInfo() {
            if (!signer) return;

            try {
                const invitation = new ethers.Contract(CONTRACTS.invitationSystem, INVITATION_ABI, provider);
                
                try {
                    const inviter = await invitation.getInviter(userAddress);
                    if (inviter === ethers.constants.AddressZero) {
                        document.getElementById('myInviter').textContent = 'æ— ';
                    } else {
                        document.getElementById('myInviter').textContent = `${inviter.substring(0, 6)}...${inviter.substring(38)}`;
                    }
                } catch {
                    document.getElementById('myInviter').textContent = 'æ— ';
                }
                
                try {
                    const inviteeCount = await invitation.inviteeCount(userAddress);
                    document.getElementById('inviteeCount').textContent = inviteeCount.toString();
                } catch {
                    document.getElementById('inviteeCount').textContent = '0';
                }
                
                document.getElementById('myInviteCode').textContent = `${userAddress.substring(0, 10)}...${userAddress.substring(38)}`;
                
            } catch (error) {
                console.error('åˆ·æ–°é‚€è¯·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // å®æ—¶æ›´æ–°
        function startRealtimeUpdate() {
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(refreshAllData, 10000); // æ¯10ç§’æ›´æ–°
        }

        // å¯åŠ¨ TEngine ä¸‹æ¬¡é‡Šæ”¾å€’è®¡æ—¶ï¼ˆåŸºäºé“¾ä¸Šæ—¶é—´è®¡ç®—çš„ä¸‹ä¸€ Epoch èµ·ç‚¹ï¼‰
        function startTengineCountdown(targetSec) {
            const el = document.getElementById('tengineNextRelease');
            if (!el) return;
            if (tengineCountdownInterval) clearInterval(tengineCountdownInterval);

            function pad(n) { return String(n).padStart(2, '0'); }
            function tick() {
                const nowMs = Date.now();
                const diffMs = targetSec * 1000 - nowMs;
                if (diffMs <= 0) {
                    el.textContent = '00:00:00';
                    clearInterval(tengineCountdownInterval);
                    // è½»é‡è§¦å‘ä¸€æ¬¡åˆ·æ–°ä»¥åŒæ­¥æ–°ä¸€è½®é‡Šæ”¾çŠ¶æ€
                    setTimeout(refreshAllData, 1500);
                    return;
                }
                const totalSec = Math.floor(diffMs / 1000);
                const h = Math.floor(totalSec / 3600);
                const m = Math.floor((totalSec % 3600) / 60);
                const s = totalSec % 60;
                el.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
            }

            tick();
            tengineCountdownInterval = setInterval(tick, 1000);
        }
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="alert ${type}">${text}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // æ£€æŸ¥å¹¶æ˜¾ç¤ºå¼€å‘è€…å…¥å£ï¼ˆä»…ownerå¯è§ï¼‰
        function checkAndShowDevEntrance() {
            const OWNER_ADDRESS = '0xd8b4286c2f299220830f7228bab15225b4ea8379';
            if (userAddress && userAddress.toLowerCase() === OWNER_ADDRESS.toLowerCase()) {
                document.getElementById('devEntrance').style.display = 'flex';
            } else {
                document.getElementById('devEntrance').style.display = 'none';
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('connectBtn').addEventListener('click', connectWallet);

        // åˆå§‹é€‰ä¸­Standard Pass
        selectPass(1);
    </script>
</body>
</html>
